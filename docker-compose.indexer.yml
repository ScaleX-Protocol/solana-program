# OpenBook Indexer Docker Compose Configuration
# Uses shared infrastructure from monitoring-tools (postgres-database, redis, timescaledb)
# Trigger deployment - 2026-02-15

services:
  # OpenBook indexer service
  openbook-indexer:
    build:
      context: .
      dockerfile: Dockerfile.indexer
    container_name: ${NETWORK:-devnet}-openbook-indexer
    env_file:
      - .env.solana-${NETWORK:-devnet}
    environment:
      # Database connection to shared PostgreSQL (network-specific database)
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@postgres-database:5432/${OPENBOOK_DATABASE:-openbook_devnet}
      - REDIS_URL=redis://redis:6379
      - API_PORT=42090
      - INDEXER_PORT=42090
      # Network identification for Redis key prefixing
      - NETWORK=${NETWORK:-devnet}
      - SOLANA_RPC_URL=${SOLANA_RPC_URL:-https://api.devnet.solana.com}
      - OPENBOOK_PROGRAM_ID=${OPENBOOK_PROGRAM_ID:-opnb2LAfJYbRMAHHvqjCwQxanZn7ReEHp1k81EohpZb}
    networks:
      - infrastructure
    restart: unless-stopped
    volumes:
      - ./logs:/app/logs
      - ./deployments:/app/deployments:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:42090/api/markets || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    ports:
      - "${INDEXER_PORT:-42090}:42090"  # Expose for direct access (optional)
    labels:
      # Traefik configuration for subdomain access
      - traefik.enable=true
      - traefik.http.services.${NETWORK:-devnet}-openbook-indexer.loadbalancer.server.port=42090
      # Dynamic Router based on NETWORK: solana-devnet-indexer.scalex.money
      - traefik.http.routers.${NETWORK:-devnet}-openbook-indexer.rule=Host(`solana-${NETWORK:-devnet}-indexer.scalex.money`)
      - traefik.http.routers.${NETWORK:-devnet}-openbook-indexer.entrypoints=websecure
      - traefik.http.routers.${NETWORK:-devnet}-openbook-indexer.tls.certresolver=letsencrypt
      - traefik.http.routers.${NETWORK:-devnet}-openbook-indexer.service=${NETWORK:-devnet}-openbook-indexer
      # HTTP redirect
      - traefik.http.routers.${NETWORK:-devnet}-openbook-indexer-http.rule=Host(`solana-${NETWORK:-devnet}-indexer.scalex.money`)
      - traefik.http.routers.${NETWORK:-devnet}-openbook-indexer-http.entrypoints=web

networks:
  infrastructure:
    external: true
