name: ðŸŒ OpenBook - Mainnet Deployment

on:
  workflow_dispatch:
    inputs:
      confirm_mainnet:
        description: 'Type "DEPLOY_TO_MAINNET" to confirm'
        required: true
        type: string
      program_buffer:
        description: 'Program buffer address (from anchor build)'
        required: true
        type: string
      upgrade_authority:
        description: 'Upgrade authority address'
        required: false
        type: string

env:
  NETWORK: mainnet-beta
  SOLANA_CLI_VERSION: 1.18.23
  RUST_VERSION: 1.79.0
  ANCHOR_VERSION: 0.28.0

jobs:
  pre-flight-checks:
    runs-on: [self-hosted, solana]
    steps:
    - name: Verify mainnet confirmation
      run: |
        if [ "${{ github.event.inputs.confirm_mainnet }}" != "DEPLOY_TO_MAINNET" ]; then
          echo "âŒ Mainnet deployment not confirmed"
          echo "Please type 'DEPLOY_TO_MAINNET' in the confirmation field"
          exit 1
        fi
        echo "âœ… Mainnet deployment confirmed"

    - name: Check required secrets
      env:
        MAINNET_DEPLOYER_KEY: ${{ secrets.MAINNET_DEPLOYER_PRIVATE_KEY }}
        MAINNET_UPGRADE_AUTHORITY: ${{ secrets.MAINNET_UPGRADE_AUTHORITY_KEY }}
      run: |
        if [ -z "$MAINNET_DEPLOYER_KEY" ]; then
          echo "âŒ MAINNET_DEPLOYER_PRIVATE_KEY secret not found"
          exit 1
        fi

        if [ -z "$MAINNET_UPGRADE_AUTHORITY" ]; then
          echo "âš ï¸ MAINNET_UPGRADE_AUTHORITY_KEY not found (optional)"
        fi

        echo "âœ… Required secrets are configured"

  deploy:
    needs: pre-flight-checks
    runs-on: [self-hosted, solana]
    environment: mainnet

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true
        profile: minimal

    - name: Set up Solana CLI
      run: |
        if ! command -v solana &> /dev/null || ! solana --version | grep -q "${{ env.SOLANA_CLI_VERSION }}"; then
          echo "Installing Solana CLI ${{ env.SOLANA_CLI_VERSION }}..."
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_CLI_VERSION }}/install)"
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        fi
        solana --version

    - name: Configure Solana for Mainnet
      run: |
        solana config set --url https://api.mainnet-beta.solana.com
        echo "Solana configured for mainnet-beta"
        solana config get

    - name: Set up wallet
      env:
        MAINNET_DEPLOYER_KEY: ${{ secrets.MAINNET_DEPLOYER_PRIVATE_KEY }}
      run: |
        echo "Setting up mainnet deployment wallet..."
        echo "$MAINNET_DEPLOYER_KEY" > /tmp/mainnet-deployer.json
        chmod 600 /tmp/mainnet-deployer.json
        solana config set --keypair /tmp/mainnet-deployer.json

        echo "Deployer address:"
        solana address

        BALANCE=$(solana balance | awk '{print $1}')
        echo "Wallet balance: $BALANCE SOL"

        # Check if sufficient balance (at least 10 SOL recommended)
        if (( $(echo "$BALANCE < 10" | bc -l) )); then
          echo "âš ï¸ Warning: Balance is below 10 SOL"
          echo "Recommended: At least 10 SOL for mainnet deployment"
        fi

    - name: Build programs from source
      run: |
        echo "=== Building OpenBook V2 from source for mainnet ==="
        cd programs/openbook-v2

        # Verify the build configuration
        echo "Checking Anchor.toml..."
        cat Anchor.toml

        # Build with mainnet settings
        anchor build --verifiable

        echo "Build completed. Checking artifacts..."
        ls -lh target/deploy/

        # Verify the program hash
        solana program dump target/deploy/openbook_v2.so /tmp/mainnet-program-verify.so
        sha256sum target/deploy/openbook_v2.so /tmp/mainnet-program-verify.so

    - name: Security audit
      run: |
        echo "=== Running security audit ==="
        cd programs/openbook-v2

        # Run cargo audit
        cargo audit || echo "âš ï¸ Audit warnings found - review before continuing"

        # Run clippy with strict settings
        cargo clippy --all-targets --all-features -- -D warnings || {
          echo "âŒ Clippy found issues - fix before mainnet deployment"
          exit 1
        }

    - name: Deploy to mainnet
      env:
        PROGRAM_BUFFER: ${{ github.event.inputs.program_buffer }}
        UPGRADE_AUTHORITY: ${{ github.event.inputs.upgrade_authority }}
      run: |
        echo "=== Deploying to Mainnet-Beta ==="
        echo "âš ï¸ This is a MAINNET deployment - proceed with caution"

        cd programs/openbook-v2

        if [ -n "$PROGRAM_BUFFER" ]; then
          echo "Using provided program buffer: $PROGRAM_BUFFER"

          # Deploy using the provided buffer
          if [ -n "$UPGRADE_AUTHORITY" ]; then
            PROGRAM_ID=$(solana program deploy --program-id $PROGRAM_BUFFER --upgrade-authority $UPGRADE_AUTHORITY --output json | jq -r '.programId')
          else
            PROGRAM_ID=$(solana program deploy --program-id $PROGRAM_BUFFER --output json | jq -r '.programId')
          fi
        else
          # Fresh deployment
          echo "Performing fresh program deployment..."
          PROGRAM_ID=$(solana program deploy target/deploy/openbook_v2.so --output json | jq -r '.programId')
        fi

        echo "âœ… Program deployed successfully!"
        echo "Program ID: $PROGRAM_ID"
        echo "OPENBOOK_MAINNET_PROGRAM_ID=$PROGRAM_ID" >> $GITHUB_ENV

        # Save to file for records
        echo "$PROGRAM_ID" > MAINNET_PROGRAM_ID.txt

    - name: Verify mainnet deployment
      run: |
        echo "============================================"
        echo "ðŸ” MAINNET DEPLOYMENT VERIFICATION"
        echo "============================================"

        echo ""
        echo "=== Program Information ==="
        PROGRAM_ID=$(cat MAINNET_PROGRAM_ID.txt)
        echo "Program ID: $PROGRAM_ID"

        solana program show $PROGRAM_ID

        echo ""
        echo "=== Deployment Cost ==="
        BALANCE_AFTER=$(solana balance | awk '{print $1}')
        echo "Remaining balance: $BALANCE_AFTER SOL"

        echo ""
        echo "âœ… Mainnet deployment verified"

    - name: Save deployment addresses to mainnet.json
      if: success()
      run: |
        echo "=== Saving deployment addresses to deployments/mainnet.json ==="

        # Create deployments directory if it doesn't exist
        mkdir -p deployments

        # Get deployment info
        PROGRAM_ID=$(cat MAINNET_PROGRAM_ID.txt)
        DEPLOYER_ADDRESS=$(solana address)
        CURRENT_BALANCE=$(solana balance)
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        # Create new deployment entry
        cat > /tmp/new-mainnet-deployment.json <<EOF
        {
          "timestamp": "$TIMESTAMP",
          "commit": "$GITHUB_SHA",
          "branch": "$GITHUB_REF_NAME",
          "deployer": "$DEPLOYER_ADDRESS",
          "deployed_by": "$GITHUB_ACTOR",
          "workflow_run": "$GITHUB_RUN_ID",
          "programs": {
            "openbook_v2": "$PROGRAM_ID",
            "program_buffer": "${{ github.event.inputs.program_buffer }}",
            "upgrade_authority": "${{ github.event.inputs.upgrade_authority }}"
          },
          "configuration": {
            "solana_cli": "$SOLANA_CLI_VERSION",
            "rust": "$RUST_VERSION",
            "anchor": "$ANCHOR_VERSION",
            "verifiable_build": true
          },
          "rpc_endpoint": "https://api.mainnet-beta.solana.com",
          "deployer_balance": "$CURRENT_BALANCE",
          "security": {
            "audit_completed": true,
            "clippy_warnings": "none",
            "github_protection": "enabled"
          },
          "status": "active"
        }
        EOF

        # Update or create mainnet.json
        if [ -f "deployments/mainnet.json" ]; then
          echo "Updating existing mainnet.json..."
          jq --argjson new "$(cat /tmp/new-mainnet-deployment.json)" \
            '.lastUpdated = "'$TIMESTAMP'" | .deployments = [$new] + .deployments' \
            deployments/mainnet.json > /tmp/mainnet-updated.json
          mv /tmp/mainnet-updated.json deployments/mainnet.json
        else
          echo "Creating new mainnet.json..."
          cat > deployments/mainnet.json <<EOF
        {
          "network": "mainnet-beta",
          "lastUpdated": "$TIMESTAMP",
          "deployments": [
            $(cat /tmp/new-mainnet-deployment.json)
          ]
        }
        EOF
        fi

        echo "âœ… Deployment addresses saved to deployments/mainnet.json"
        cat deployments/mainnet.json

    - name: Create pull request with deployment addresses
      if: success()
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: add mainnet deployment addresses

          Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Program ID: $(cat MAINNET_PROGRAM_ID.txt)
          Deployed by: ${{ github.actor }}
          Workflow: ${{ github.run_id }}
        branch: mainnet-deployment-${{ github.run_id }}
        delete-branch: true
        title: 'ðŸš€ Mainnet Deployment: $(date +%Y-%m-%d)'
        body: |
          ## Mainnet Deployment Record

          **âš ï¸ MAINNET DEPLOYMENT - PRODUCTION**

          This PR adds the mainnet deployment addresses to `deployments/mainnet.json`.

          ### Deployment Details
          - **Program ID**: $(cat MAINNET_PROGRAM_ID.txt)
          - **Deployed By**: ${{ github.actor }}
          - **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Workflow**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### Next Steps
          1. Review deployment addresses
          2. Approve and merge this PR
          3. Monitor program performance
          4. Update production documentation

          ---
          *Auto-generated by GitHub Actions*
        labels: |
          deployment
          mainnet
          production
        assignees: ${{ github.actor }}

    - name: Create mainnet deployment record
      if: success()
      run: |
        PROGRAM_ID=$(cat MAINNET_PROGRAM_ID.txt)

        cat > MAINNET_DEPLOYMENT_$(date +%Y%m%d_%H%M%S).md <<EOF
        # OpenBook Mainnet Deployment Record

        **âš ï¸ MAINNET DEPLOYMENT - PRODUCTION**

        **Deployment Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
        **Network:** Mainnet-Beta
        **Commit SHA:** ${GITHUB_SHA}
        **Branch:** ${GITHUB_REF_NAME}
        **Deployed By:** ${GITHUB_ACTOR}

        ## Program Details

        - **Program ID**: \`${PROGRAM_ID}\`
        - **Program Buffer**: ${{ github.event.inputs.program_buffer }}
        - **Upgrade Authority**: ${{ github.event.inputs.upgrade_authority }}

        ## Deployment Configuration

        - Solana CLI: ${SOLANA_CLI_VERSION}
        - Rust: ${RUST_VERSION}
        - Anchor: ${ANCHOR_VERSION}
        - RPC Endpoint: https://api.mainnet-beta.solana.com

        ## Deployer Information

        - Address: $(solana address)
        - Final Balance: $(solana balance)

        ## Deployment Record

        - Saved to: \`deployments/mainnet.json\`
        - PR Created: Check PRs for mainnet-deployment-${GITHUB_RUN_ID}
        - Workflow Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}

        ## Verification

        Verify the deployment:
        \`\`\`bash
        solana program show ${PROGRAM_ID} --url https://api.mainnet-beta.solana.com
        cat deployments/mainnet.json | jq '.deployments[0]'
        \`\`\`

        ## Next Steps

        1. âœ… Monitor program performance
        2. âœ… Review and merge deployment PR
        3. âœ… Set up alerts and monitoring
        4. âœ… Document program ID in production configuration
        5. âœ… Create announcement for community
        6. âœ… Update documentation with mainnet details

        ## Security Notes

        - Program deployed with verifiable build
        - Security audit completed
        - All clippy warnings resolved
        - Upgrade authority configured: ${{ github.event.inputs.upgrade_authority || 'Default' }}

        ## Emergency Contacts

        - Deployer: ${GITHUB_ACTOR}
        - Deployment Job: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}

        ---
        *This is an automated deployment record*
        EOF

        cat MAINNET_DEPLOYMENT_*.md

    - name: Cleanup sensitive data
      if: always()
      run: |
        echo "Cleaning up sensitive files..."
        rm -f /tmp/mainnet-deployer.json
        rm -f /tmp/mainnet-program-verify.so
        echo "âœ… Cleanup completed"

    - name: Notify success
      if: success()
      run: |
        echo "============================================"
        echo "ðŸŽ‰ MAINNET DEPLOYMENT SUCCESSFUL"
        echo "============================================"
        echo ""
        echo "Program ID: $(cat MAINNET_PROGRAM_ID.txt)"
        echo ""
        echo "âš ï¸ IMPORTANT POST-DEPLOYMENT STEPS:"
        echo "1. Update production configuration with new Program ID"
        echo "2. Monitor program performance for 24 hours"
        echo "3. Run smoke tests on mainnet"
        echo "4. Update user documentation"
        echo "5. Announce deployment to community"
        echo ""
        echo "Deployment record saved to MAINNET_DEPLOYMENT_*.md"
        echo "============================================"

    - name: Notify failure
      if: failure()
      run: |
        echo "============================================"
        echo "âŒ MAINNET DEPLOYMENT FAILED"
        echo "============================================"
        echo ""
        echo "The deployment has failed. DO NOT retry without:"
        echo "1. Reviewing the error logs above"
        echo "2. Verifying the build artifacts"
        echo "3. Confirming sufficient SOL balance"
        echo "4. Checking network connectivity"
        echo ""
        echo "Contact the DevOps team before retrying."
        echo "============================================"
