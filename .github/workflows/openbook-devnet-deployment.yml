name: ðŸš€ OpenBook - Devnet Deployment

on:
  push:
    branches: [ devnet-deployment ]
    paths:
      - 'packages/scripts/**'
      - 'programs/**'
      - 'crates/**'
      - '.github/workflows/openbook-devnet-deployment.yml'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip building programs (use pre-built)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  NETWORK: devnet
  SOLANA_CLI_VERSION: 1.18.23
  RUST_VERSION: 1.79.0
  ANCHOR_VERSION: 0.28.0

jobs:
  deploy:
    runs-on: [self-hosted, solana]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true
        profile: minimal

    - name: Set up Solana CLI
      run: |
        if ! command -v solana &> /dev/null || ! solana --version | grep -q "${{ env.SOLANA_CLI_VERSION }}"; then
          echo "Installing Solana CLI ${{ env.SOLANA_CLI_VERSION }}..."
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_CLI_VERSION }}/install)"
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        else
          echo "Solana CLI ${{ env.SOLANA_CLI_VERSION }} already installed"
          solana --version
        fi

    - name: Set up Anchor
      run: |
        if ! command -v anchor &> /dev/null || ! anchor --version | grep -q "${{ env.ANCHOR_VERSION }}"; then
          echo "Installing Anchor ${{ env.ANCHOR_VERSION }}..."
          cargo install --git https://github.com/coral-xyz/anchor --tag v${{ env.ANCHOR_VERSION }} anchor-cli --locked --force
        else
          echo "Anchor ${{ env.ANCHOR_VERSION }} already installed"
          anchor --version
        fi

    - name: Configure Solana for Devnet
      run: |
        solana config set --url https://api.devnet.solana.com
        echo "Solana configured for devnet"
        solana config get

    - name: Set up wallet
      env:
        SOLANA_DEPLOYER_PRIVATE_KEY: ${{ secrets.SOLANA_DEPLOYER_PRIVATE_KEY }}
      run: |
        echo "Setting up deployment wallet..."
        if [ -z "$SOLANA_DEPLOYER_PRIVATE_KEY" ]; then
          echo "âŒ SOLANA_DEPLOYER_PRIVATE_KEY secret not found"
          echo "Using default devnet wallet from filesystem..."
        else
          echo "$SOLANA_DEPLOYER_PRIVATE_KEY" > /tmp/deployer-keypair.json
          solana config set --keypair /tmp/deployer-keypair.json
        fi

        echo "Current wallet address:"
        solana address

        echo "Wallet balance:"
        solana balance

    - name: Request airdrop if needed
      run: |
        BALANCE=$(solana balance | awk '{print int($1)}')
        echo "Current balance: $BALANCE SOL"

        if [ "$BALANCE" -lt 5 ]; then
          echo "Balance low, requesting airdrop..."
          for i in {1..3}; do
            solana airdrop 2 && break
            echo "Airdrop attempt $i failed, retrying..."
            sleep 5
          done
          echo "New balance:"
          solana balance
        else
          echo "âœ… Sufficient balance for deployment"
        fi

    - name: Download pre-built programs
      if: ${{ github.event.inputs.skip_build == 'true' || github.event.inputs.skip_build == '' }}
      run: |
        echo "=== Downloading pre-built programs from devnet ==="
        mkdir -p /tmp/programs

        echo "Downloading OpenBook V2 program..."
        solana program dump opnb2LAfJYbRMAHHvqjCwQxanZn7ReEHp1k81EohpZb /tmp/programs/openbook_v2.so --url https://api.devnet.solana.com || {
          echo "âŒ Failed to download OpenBook V2 program"
          exit 1
        }

        echo "Downloading Metaplex Token Metadata program..."
        solana program dump metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s /tmp/programs/metaplex_token_metadata.so --url https://api.devnet.solana.com || {
          echo "âŒ Failed to download Metaplex program"
          exit 1
        }

        echo "âœ… Programs downloaded successfully"
        ls -lh /tmp/programs/

    - name: Build programs from source
      if: ${{ github.event.inputs.skip_build == 'false' }}
      run: |
        echo "=== Building OpenBook V2 from source ==="
        cd programs/openbook-v2
        anchor build

        echo "Copying built program..."
        mkdir -p /tmp/programs
        cp target/deploy/openbook_v2.so /tmp/programs/

        echo "âœ… Build completed successfully"
        ls -lh /tmp/programs/

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install pnpm
      run: |
        npm install -g pnpm@8

    - name: Install dependencies
      run: |
        echo "Installing workspace dependencies..."
        pnpm install

    - name: Deploy OpenBook program to devnet
      env:
        SOLANA_DEPLOYER_PRIVATE_KEY: ${{ secrets.SOLANA_DEPLOYER_PRIVATE_KEY }}
      run: |
        echo "=== Deploying OpenBook V2 program to devnet ==="

        # Deploy the program
        PROGRAM_ID=$(solana program deploy /tmp/programs/openbook_v2.so --output json | jq -r '.programId')

        echo "Program deployed successfully!"
        echo "Program ID: $PROGRAM_ID"
        echo "OPENBOOK_PROGRAM_ID=$PROGRAM_ID" >> $GITHUB_ENV

    - name: Create environment file
      env:
        OPENBOOK_PROGRAM_ID: ${{ env.OPENBOOK_PROGRAM_ID }}
      run: |
        echo "=== Creating deployment environment file ==="
        cat > packages/scripts/.env.devnet <<EOF
        SOLANA_RPC_URL=https://api.devnet.solana.com
        NETWORK=devnet
        OPENBOOK_PROGRAM_ID=${OPENBOOK_PROGRAM_ID:-opnb2LAfJYbRMAHHvqjCwQxanZn7ReEHp1k81EohpZb}
        METAPLEX_PROGRAM_ID=metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s
        EOF

        echo "Environment file created:"
        cat packages/scripts/.env.devnet

    - name: Deploy markets
      run: |
        echo "=== Deploying OpenBook markets to devnet ==="
        cd packages/scripts

        # Run the deployment script
        pnpm run deploy-devnet || {
          echo "âŒ Market deployment failed"
          echo "Checking logs..."
          exit 1
        }

        echo "âœ… Markets deployed successfully"

    - name: Verify deployment
      run: |
        echo "============================================"
        echo "ðŸ” DEPLOYMENT VERIFICATION - OPENBOOK DEVNET"
        echo "============================================"

        echo ""
        echo "=== 1. PROGRAM STATUS CHECK ==="
        echo "OpenBook Program ID: ${OPENBOOK_PROGRAM_ID:-opnb2LAfJYbRMAHHvqjCwQxanZn7ReEHp1k81EohpZb}"
        solana program show ${OPENBOOK_PROGRAM_ID:-opnb2LAfJYbRMAHHvqjCwQxanZn7ReEHp1k81EohpZb}

        echo ""
        echo "=== 2. WALLET STATUS ==="
        echo "Deployer address:"
        solana address
        echo "Remaining balance:"
        solana balance

        echo ""
        echo "=== 3. MARKET VERIFICATION ==="
        cd packages/scripts
        echo "Viewing deployed markets..."
        pnpm run view-markets || echo "âš ï¸ Could not retrieve market information"

        echo ""
        echo "============================================"
        echo "ðŸŽ¯ OPENBOOK DEVNET DEPLOYMENT COMPLETE"
        echo "============================================"

    - name: Run post-deployment tests
      run: |
        echo "=== Running post-deployment tests ==="
        cd packages/scripts

        echo "Test 1: View markets"
        pnpm run get-markets || echo "âš ï¸ Market retrieval test failed"

        echo ""
        echo "Test 2: Check indexer connectivity"
        pnpm run test-indexer || echo "âš ï¸ Indexer test skipped (optional)"

        echo "âœ… Post-deployment tests completed"

    - name: Save deployment addresses
      if: success()
      run: |
        echo "=== Saving deployment addresses to deployments/devnet.json ==="

        # Create deployments directory if it doesn't exist
        mkdir -p deployments

        # Get current deployment info
        DEPLOYER_ADDRESS=$(solana address)
        CURRENT_BALANCE=$(solana balance)
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        PROGRAM_ID=${OPENBOOK_PROGRAM_ID:-opnb2LAfJYbRMAHHvqjCwQxanZn7ReEHp1k81EohpZb}

        # Create new deployment entry
        cat > /tmp/new-deployment.json <<EOF
        {
          "timestamp": "$TIMESTAMP",
          "commit": "$GITHUB_SHA",
          "branch": "$GITHUB_REF_NAME",
          "deployer": "$DEPLOYER_ADDRESS",
          "workflow_run": "$GITHUB_RUN_ID",
          "programs": {
            "openbook_v2": "$PROGRAM_ID",
            "metaplex_metadata": "metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"
          },
          "configuration": {
            "solana_cli": "$SOLANA_CLI_VERSION",
            "rust": "$RUST_VERSION",
            "anchor": "$ANCHOR_VERSION"
          },
          "rpc_endpoint": "https://api.devnet.solana.com",
          "deployer_balance": "$CURRENT_BALANCE",
          "status": "active"
        }
        EOF

        # Update or create devnet.json
        if [ -f "deployments/devnet.json" ]; then
          echo "Updating existing devnet.json..."
          # Read existing file and prepend new deployment
          jq --argjson new "$(cat /tmp/new-deployment.json)" \
            '.lastUpdated = "'$TIMESTAMP'" | .deployments = [$new] + .deployments' \
            deployments/devnet.json > /tmp/devnet-updated.json
          mv /tmp/devnet-updated.json deployments/devnet.json
        else
          echo "Creating new devnet.json..."
          cat > deployments/devnet.json <<EOF
        {
          "network": "devnet",
          "lastUpdated": "$TIMESTAMP",
          "deployments": [
            $(cat /tmp/new-deployment.json)
          ]
        }
        EOF
        fi

        echo "âœ… Deployment addresses saved to deployments/devnet.json"
        cat deployments/devnet.json

    - name: Commit deployment addresses
      if: success()
      run: |
        echo "=== Committing deployment addresses ==="

        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        git add deployments/devnet.json

        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: update devnet deployment addresses [skip ci]

        Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Commit: $GITHUB_SHA
        Workflow: $GITHUB_RUN_ID
        Program: ${OPENBOOK_PROGRAM_ID:-opnb2LAfJYbRMAHHvqjCwQxanZn7ReEHp1k81EohpZb}"

          git push origin HEAD:$GITHUB_REF_NAME || echo "âš ï¸ Could not push deployment addresses"
        fi

    - name: Create deployment summary
      if: always()
      run: |
        echo "=== Creating deployment summary ==="
        cat > DEVNET_DEPLOYMENT_$(date +%Y%m%d_%H%M%S).md <<EOF
        # OpenBook Devnet Deployment Summary

        **Deployment Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
        **Network:** Devnet
        **Commit:** ${GITHUB_SHA}
        **Branch:** ${GITHUB_REF_NAME}

        ## Deployed Programs

        - **OpenBook V2 Program**: ${OPENBOOK_PROGRAM_ID:-opnb2LAfJYbRMAHHvqjCwQxanZn7ReEHp1k81EohpZb}
        - **Metaplex Token Metadata**: metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s

        ## Deployment Configuration

        - Solana CLI: ${SOLANA_CLI_VERSION}
        - Rust: ${RUST_VERSION}
        - Anchor: ${ANCHOR_VERSION}
        - RPC Endpoint: https://api.devnet.solana.com

        ## Deployer Wallet

        - Address: $(solana address)
        - Final Balance: $(solana balance)

        ## Deployment Record

        - Saved to: \`deployments/devnet.json\`
        - Workflow Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}

        ## Next Steps

        1. Verify markets: \`cd packages/scripts && pnpm run view-markets\`
        2. Place test order: \`pnpm run post-order-devnet\`
        3. Check indexer: \`pnpm run indexer\`
        4. View deployment record: \`cat deployments/devnet.json\`

        EOF

        cat DEVNET_DEPLOYMENT_*.md

    - name: Cleanup sensitive files
      if: always()
      run: |
        echo "Cleaning up temporary files..."
        rm -f /tmp/deployer-keypair.json
        rm -f packages/scripts/.env.devnet
        echo "âœ… Cleanup completed"

    - name: Notify on failure
      if: failure()
      run: |
        echo "============================================"
        echo "âŒ DEPLOYMENT FAILED"
        echo "============================================"
        echo ""
        echo "Check the logs above for detailed error information."
        echo "Common issues:"
        echo "  - Insufficient SOL balance"
        echo "  - Program build failures"
        echo "  - Network connectivity issues"
        echo "  - Invalid program ID"
        echo ""
        echo "For help, check the deployment documentation:"
        echo "  - DEVNET_DEPLOYMENT.md"
        echo "  - DEVNET_SOLUTIONS.md"
        echo "============================================"
